function generateProtocol(child, pastSessions) {

    // -------- Helper functions ----------------------------------------------

    // See http://stackoverflow.com/a/12646864
    // Returns a new array with elements of the array in random order.
    function shuffle(array) {
        var shuffled = Ember.$.extend(true, [], array); // deep copy array
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = shuffled[i];
            shuffled[i] = shuffled[j];
            shuffled[j] = temp;
        }
        return shuffled;
    }

    // Returns a random element of an array, and removes that element from the array
    function pop_random(array) {
        if (array.length) {
            let randIndex = Math.floor(Math.random() * array.length);
            return array.splice(randIndex, 1)[0];
        }
        return null;
    }

    // Returns durations for highlighting options
    function highlight_lengths(options_lengths, story, options_order) {
        var intro_l = "intro-length";
        var intro = options_lengths[story][intro_l];
        var or = 0.85;
        var first = [intro, intro+options_lengths[story][options_order[0]+'-length']];
        var second = [first[1], first[1]+options_lengths[story][options_order[1]+'-length']];
        var third = [second[1]+or, second[1]+or+options_lengths[story][options_order[2]+'-length']];
        return [first, second, third];
    }

    // -------- End helper functions -------------------------------------------

    // Define common (non-test-trial) frames
    let frames = {
        "exit-survey": {
            "kind": "exp-lookit-exit-survey",
            "debriefing": {
                "text": "Here is where you would enter debriefing information for the family. This is a chance to explain the purpose of your study and how the family helped; at this point it's more obvious to the participant that skimming the info is fine if they're not super-interested, so you can elaborate in ways you might have avoided ahead of time in the interest of keeping instructions short. You may want to mention the various conditions kids were assigned to if you didn't before, and try to head off any concerns parents might have about how their child 'did' on the study, especially if there are 'correct' answers that will have been obvious to a parent. <br><br> It is great if you can link people to a layperson-accessible article on a related topic - e.g., media coverage of one of your previous studies in this research program, a talk on Youtube, a parenting resource. <br><br> If you are compensating participants, restate what the compensation is (and any conditions, and let them know when to expect their payment! E.g.: To thank you for your participation, we'll be emailing you a $4 Amazon gift card - this should arrive in your inbox within the next week after we confirm your consent video and check that your child is in the age range for this study. (If you don't hear from us by then, feel free to reach out!) If you participate again with another child in the age range, you'll receive one gift card per child.",
                "title": "Thank you!"
            }
        },
        "instructions": {
            "kind": "exp-lookit-instructions",
            "blocks": [
                {
                    "title": "Overview of how to participate in this study",
                    "listblocks": [
                        {
                            "text": "This is an 'exp-lookit-instructions' frame."
                        },
                        {
                            "text": "See https://lookit.github.io/ember-lookit-frameplayer/classes/ExpLookitInstructions.html"
                        },
                        {
                            "text": "You can display any text, audio, images, and video you want, and can optionally require participants to play audio/video segments to move on. You can also choose whether to display the webcam."
                        }
                    ]
                },
                {
                    "text": "Please try playing this sample audio to make sure you'll be able to hear the story.",
                    "title": "Adjust your speakers",
                    "mediaBlock": {
                        "text": "You should hear 'Ready to go?'",
                        "isVideo": false,
                        "sources": [
                            {
                                "src": "https://s3.amazonaws.com/lookitcontents/exp-physics-final/audio/ready.mp3",
                                "type": "audio/mp3"
                            },
                            {
                                "src": "https://s3.amazonaws.com/lookitcontents/exp-physics-final/audio/ready.ogg",
                                "type": "audio/ogg"
                            }
                        ],
                        "mustPlay": true,
                        "warningText": "Please try playing the sample audio."
                    }
                }
            ],
            "showWebcam": true,
            "webcamBlocks": [
                {
                    "title": "Make sure we can see you",
                    "listblocks": [
                        {
                            "text": "Take a look at your webcam view above. Get comfy, and adjust your own position or the computer as needed so both you and your child are visible."
                        },
                        {
                            "text": "This isn't a Skype call - no one in the lab can see you - but the recorded video of your participation will be sent to the lab to help with data analysis. It's helpful for us to be able to see if your child was pointing or looking confused, for example."
                        }
                    ]
                }
            ],
            "nextButtonText": "Next"
        },
        "video-config": {
            "kind": "exp-video-config",
            "troubleshootingIntro": "This is a standard frame you probably want to put at the very start of your study. You can customize this bit of text; the rest is standard and maintained by Lookit."
        },
        "video-consent": {
            "kind": "exp-lookit-video-consent",
            "template": "consent_005",
            "PIName": "Lookit Tutorial Participant",
            "PIContact": "Jane Smith at (123) 456-7890",
            "include_databrary": true,
            "risk_statement": "There are no expected risks to participation.",
            "datause": "We are interested in how your child uses statistical evidence to figure out the cause of an event. A research assistant will watch your video and mark down your child's answer to the question at the end of the story, and as well as other information such as interactions between you and your child during the story.",
            "payment": "After you finish the study, we will email you a $5 BabyStore gift card within approximately three days. To be eligible for the gift card your child must be in the age range for this study, you need to submit a valid consent statement, and we need to see that there is a child with you. But we will send a gift card even if you do not finish the whole study or we are not able to use your child's data! There are no other direct benefits to you or your child from participating, but we hope you will enjoy the experience.",
            "purpose": "This study is about how children use statistical information to adjust their beliefs about cause and effect.",
            "procedures": "In this study you child will view a digital 'storybook' about Bunny, who sometimes gets a tummyache. Each day Bunny eats different foods and does different activities, and we hear whether she gets a tummyache. Sometimes, Bunny feels scared because of show-and-tell. We are interested in how the pattern of evidence influences your child's beliefs about what causes Bunny's tummyache. We will ask you (the parent) to avoid discussing why Bunny has a tummyache until the end of the study. There are no anticipated risks associated with participating.",
            "institution": "Science University"
        },
        "warmup": {
            "kind": "group",
            "frameList": [
                {
                    "audio": "RockySnackIntro",
                    "images": [
                        {
                            "id": "RockySnack",
                            "src": "rockyRaccoon.jpg",
                            "height": 80,
                            "left": 30
                        }
                    ]
                },
                
               {
                    "audio": "RockySnackChoices",
                    "images": [
                        {
                            "id": "cue",
                            "src": "rockyRaccoon.jpg",
                            "top": 0,
                            "height": 60,
                            "left": 30,
                            "nonChoiceOption": true
                        },
                        {
                            "id": "option1",
                            "src": "strawberry_cropped.jpg",
                            "top": 60,
                            "left": 10,
                            "width": 13,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockySnackFollowUp"
                        },
                        {
                            "id": "option2",
                            "src": "apple.jpg",
                            "top": 60,
                            "left": 40,
                            "width": 14,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockySnackFollowUp"
                        },
                        {
                            "id": "option3",
                            "src": "chocolate.jpg",
                            "top": 68,
                            "left":70,
                            "width": 19,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockySnackFollowUp"
                        }
                    ],
                    "highlights": [
                        {
                            "range": [
                                4,
                                5
                            ],
                            "imageId": "option1"
                        },
                        {
                            "range": [
                                5,
                                6.5
                            ],
                            "imageId": "option2"
                        },
                        {
                            "range": [
                                6.5,
                                8
                            ],
                            "imageId": "option3"
                        }
                    ],
                    "autoProceed": false,
                    "doRecording": false,
                    "choiceRequired": true,
                    "allowUserPause": false
                },
                {
                    "audio": "RockyHideIntro",
                    "images": [
                        {
                            "id": "RockyHide",
                            "src": "RockyFox.jpg",
                            "height": 80,
                            "left": 10
                        }
                    ]
                },
                
               {
                    "audio": "RockyHideOptions",
                    "images": [
                        {
                            "id": "cue",
                            "src": "rockyRaccoon.jpg",
                            "top": 0,
                            "height": 60,
                            "left": 30,
                            "nonChoiceOption": true
                        },
                        {
                            "id": "option1",
                            "src": "rock.jpg",
                            "top": 67,
                            "left": 10,
                            "width": 20,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockyHideFollowUp"
                        },
                        {
                            "id": "option2",
                            "src": "tree.jpg",
                            "top": 67,
                            "left": 40,
                            "width": 20,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockyHideFollowUp"
                        },
                        {
                            "id": "option3",
                            "src": "cave.jpg",
                            "top": 67,
                            "left":70,
                            "width": 20,
                            "displayDelayMs": 0,
                            "feedbackAudio": "RockyHideFollowUp"
                        }
                    ],
                    "highlights": [
                        {
                            "range": [
                                4,
                                5
                            ],
                            "imageId": "option1"
                        },
                        {
                            "range": [
                                5,
                                6.5
                            ],
                            "imageId": "option2"
                        },
                        {
                            "range": [
                                6.5,
                                8
                            ],
                            "imageId": "option3"
                        }
                    ],
                    "autoProceed": false,
                    "doRecording": false,
                    "choiceRequired": true,
                    "allowUserPause": false
                }
            ],
            "commonFrameProperties": {
                "kind": "exp-lookit-images-audio",
                "baseDir": "https://raw.githubusercontent.com/buksters/WHN/main/",
                "id": "storybook-group",
                "audioTypes": [
                    "ogg"
                ],
                "autoProceed": false,
                "doRecording": false,
                "parentTextBlock": {
                    "css": {
                        "font-size": "1.5em"
                    },
                    "text": "Please don't respond to anything on the screen. Feel free to replay the audio if your child was distracted.",
                    "title": "For parents"
                }
            }
        }
    };


    // Start off the frame sequence with config/consent frames; we'll add test
    // trials as we construct them
    let frame_sequence = [];

    let stories = ['tablet', 'room', 'jumping', 'outside', 'writing', 'computer', 'm&ms', 'popcorn', 'tub', 'laundry', 'peas', 'jacket'];
    let conditions = ['aligned', 'misaligned'];
    let options = ['c', 'l', 'nc'];
    let full = {
        'c': '/large_compliance.jpg',
        'l': '/large_loophole.jpg',
        'nc': '/large_noncompliance.jpg'
    };
    let options_lengths = {

        'tablet': 
        {
            'intro-length': 5.72,
            'c-length': 8.23,
            'l-length': 6.68,
            'nc-length': 5.4
        },
        'computer': 
        {
            'intro-length': 6.16,
            'c-length': 6.27,
            'l-length': 8.0,
            'nc-length': 5.38
        },
        'room': 
        {
            'intro-length': 7.1,
            'c-length': 7.04,
            'l-length': 6.63,
            'nc-length': 6.16
        },
        'writing':
        {
            'intro-length': 6.76,
            'c-length': 5.69,
            'l-length': 4.82,
            'nc-length': 6.21
        },
        'jumping':
        {
            'intro-length': 7.25,
            'c-length': 5.57,
            'l-length': 8.08,
            'nc-length': 5.05
        },
        'outside': 
        {
            'intro-length': 6.85,
            'c-length': 6.1,
            'l-length': 6.53,
            'nc-length': 6.31
        },
        'peas':
        {
            'intro-length': 6.27,
            'c-length': 5.27,
            'l-length': 4.99,
            'nc-length': 5.35
        },
        'popcorn':
        {
            'intro-length': 6.44,
            'c-length': 4.5,
            'l-length': 6.76,
            'nc-length': 4.37
        },
        'jacket':
        {
            'intro-length': 6.78,
            'c-length': 4.33,
            'l-length': 5.03,
            'nc-length': 4.59
        },
        'tub':
        {
            'intro-length': 7.08,
            'c-length': 5.99,
            'l-length': 7.49,
            'nc-length': 5.07
        },
        'laundry':
        {
            'intro-length': 6.38,
            'c-length': 4.93,
            'l-length': 4.61,
            'nc-length': 4.78
        },
        'm&ms':
        {
            'intro-length': 6.4,
            'c-length': 4.95,
            'l-length': 5.05,
            'nc-length': 4.67
        }
    };

    // Choose a random starting point and order for the category pairings
    let ordered_stories = shuffle(stories);
    let first_two = shuffle([0,1]);
    let last_four = shuffle([0,0,1,1]);
    let conditions_order = [...first_two, ...last_four];
    console.log("ORDER CHECK");
    console.log(conditions_order);

    for (iTrial = 0; iTrial < 6; iTrial++) {

        let this_story = ordered_stories[iTrial];
        let this_condition = conditions[conditions_order[iTrial]]; //0 or 1
        let options_order = shuffle(options);
        let options_order_name = options_order.join('-');
        let highlights = highlight_lengths(options_lengths, this_story, options_order);
        console.log(highlights);

        thisTrial = {
            "kind": "group",
            "sampler": "random-parameter-set",
            "frameList": [
                {
                    "audio": this_story + '/story_intro',
                    "images": [
                        {
                            "id": "story-intro",
                            "src": this_story + "/noParent.jpg",
                            "position": "fill"
                        }
                    ]
                },
                {
                    "audio": this_story + '/parent_combined',
                    "images": [
                        {
                            "id": "story-parent",
                            "src": this_story + "/parent.jpg",
                            "position": "fill"
                        }
                    ]
                },
                {
                    "audio": this_story + '/' + this_condition + '_combined',
                    "images": [
                        {
                            "id": "story-parent-wants",
                            "src": this_story + "/parent.jpg",
                            "position": "fill"
                        }
                    ]
                },
                {
                    "audio": this_story + "/" + options_order_name,
                    "images": [
                        {
                            "id": "option1",
                            "src": this_story + full[options_order[0]],
                            "top": 5,
                            "left": 5,
                            "width": 30,
                            "displayDelayMs": 0
                        },
                        {
                            "id": "option2",
                            "src": this_story + full[options_order[1]],
                            "top": 35,
                            "left": 35,
                            "width": 30,
                            "displayDelayMs": 0
                        },
                        {
                            "id": "option3",
                            "src": this_story + full[options_order[2]],
                            "top": 65,
                            "left":65,
                            "width": 30,
                            "displayDelayMs": 0
                        }
                    ],
                    "highlights": [
                        {
                            "range": highlights[0],
                            "imageId": "option1",
                            "color": "red"
                        },
                        {
                            "range": highlights[1],
                            "imageId": "option2",
                            "color": "red"
                        },
                        {
                            "range": highlights[2],
                            "imageId": "option3"
                        }
                    ],
                    "doRecording": false,
                    "choiceRequired": true,
                    "allowUserPause": false
                }
            ],
            "commonFrameProperties": {
                "baseDir": "https://raw.githubusercontent.com/buksters/WHN/main/",
                "kind": "exp-lookit-images-audio",
                "id": "storybook-group",
                "audioTypes": [
                    "mp3"
                ],
                "autoProceed": false,
                "canMakeChoiceBeforeAudioFinished": false,
                "doRecording": false,
                "parentTextBlock": {
                    "css": {
                        "font-size": "1.5em"
                    },
                    "text": "Please don't respond to anything on the screen. Feel free to replay the audio if your child was distracted.",
                    "title": "For parents"
                }
            },
        };

        // Store this frame in frames and in the sequence
        frameId = 'test-trial-' + (iTrial + 1);
        frames[frameId] = thisTrial;
        frame_sequence.push(frameId);
    }

    // Finish up the frame sequence with the exit survey
    // frame_sequence = frame_sequence.concat(['exit-survey']);

    // Return a study protocol with "frames" and "sequence" fields just like when
    // defining the protocol in JSON only
    return {
        frames: frames,
        sequence: frame_sequence
    };
}